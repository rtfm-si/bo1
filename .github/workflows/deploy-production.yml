name: Deploy to Production

on:
  workflow_dispatch:  # Manual trigger ONLY
    inputs:
      confirm:
        description: 'Type "deploy-to-production" to confirm'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_API: ${{ github.repository }}/api
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  validate-confirmation:
    name: Validate Deployment Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy-to-production" ]; then
            echo "‚ùå Deployment confirmation failed!"
            echo "You must type 'deploy-to-production' to confirm."
            exit 1
          fi
          echo "‚úÖ Deployment confirmed"

  pre-deployment-checks:
    name: Pre-Deployment Checks
    needs: validate-confirmation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check staging health (optional)
        run: |
          echo "Checking staging environment health..."
          # TODO: Add monitoring check (Grafana API, Prometheus, etc.)
          # For now, just check if staging is responsive (non-blocking)
          if curl --fail --silent --max-time 5 https://staging.boardof.one/api/health 2>/dev/null; then
            echo "‚úÖ Staging is healthy"
          else
            echo "‚ö†Ô∏è  Staging is not available (skipping - not required for deployment)"
          fi

      - name: Verify all tests passed (optional)
        run: |
          echo "Verifying CI status..."
          # Check if CI tests passed on main (non-blocking)
          STATUS=$(gh api repos/${{ github.repository }}/commits/main/status --jq '.state' 2>/dev/null || echo "no-status")
          if [ "$STATUS" = "success" ]; then
            echo "‚úÖ All tests passed on main"
          elif [ "$STATUS" = "no-status" ]; then
            echo "‚ö†Ô∏è  No CI status found (skipping - not required)"
          else
            echo "‚ö†Ô∏è  CI status: $STATUS (continuing anyway)"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for security alerts
        run: |
          echo "Checking for open security alerts..."
          # TODO: Add Dependabot/security alert check
          echo "‚ö†Ô∏è  Manual security review required"

  build-and-push:
    name: Build & Push Production Images
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}
          tags: |
            type=sha,prefix=prod-
            type=raw,value=production-latest
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=sha,prefix=prod-
            type=raw,value=production-latest
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-to-production:
    name: Deploy to Production (Safe Restart)
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://boardof.one

    steps:
      - uses: actions/checkout@v4

      - name: Verify secrets are set
        run: |
          if [ -z "${{ secrets.PRODUCTION_HOST }}" ]; then
            echo "‚ùå PRODUCTION_HOST secret is not set!"
            echo "Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "Add secret: PRODUCTION_HOST with value: 139.59.201.65"
            exit 1
          fi
          if [ -z "${{ secrets.PRODUCTION_USER }}" ]; then
            echo "‚ùå PRODUCTION_USER secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.PRODUCTION_SSH_KEY }}" ]; then
            echo "‚ùå PRODUCTION_SSH_KEY secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.POSTGRES_PASSWORD }}" ]; then
            echo "‚ùå POSTGRES_PASSWORD secret is not set!"
            echo "Generate one with: openssl rand -base64 32"
            exit 1
          fi
          echo "‚úÖ All required secrets are set"
          echo "Host: ${{ secrets.PRODUCTION_HOST }}"
          echo "User: ${{ secrets.PRODUCTION_USER }}"

      - name: Safe Deployment to Production
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_SHA: ${{ github.sha }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME_API: ${{ env.IMAGE_NAME_API }}
          IMAGE_NAME_FRONTEND: ${{ env.IMAGE_NAME_FRONTEND }}
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SSH_PORT || '22' }}
          envs: GITHUB_SHA,REGISTRY,IMAGE_NAME_API,IMAGE_NAME_FRONTEND
          script: |
            set -e

            # Navigate to deployment directory
            cd /opt/boardofone

            # Backup current state
            echo "Creating backup of current deployment..."
            docker-compose -f docker-compose.prod.yml ps > /tmp/pre-deploy-state.txt

            # Pull latest configuration (stash any local changes first)
            git stash --include-untracked || true
            git pull origin main

            # Create override file for production-specific settings (if not exists)
            if [ ! -f docker-compose.prod.override.yml ]; then
              echo "Creating production override file..."
              cat > docker-compose.prod.override.yml <<'OVERRIDE_EOF'
            # Production-specific overrides (not tracked in git)
            services:
              nginx:
                image: nginx:1.25-alpine
                container_name: bo1-nginx-prod
                depends_on:
                  - api
                  - frontend
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
                  - /etc/letsencrypt/live/boardof.one:/etc/nginx/ssl:ro
                  - nginx-logs:/var/log/nginx
                  - nginx-cache:/var/cache/nginx
                networks:
                  - bo1-network
                restart: unless-stopped
            OVERRIDE_EOF
            fi

            # Build images locally (faster and more reliable than pulling from registry)
            echo "Building images locally..."
            docker-compose -f docker-compose.prod.yml -f docker-compose.prod.override.yml build --no-cache

            # Safe Deployment with Health Checks
            echo "Stopping current environment..."

            # Stop old containers (brief downtime, but prevents port conflicts)
            docker-compose -f docker-compose.prod.yml -f docker-compose.prod.override.yml down

            # Start new containers
            echo "Starting new environment..."
            docker-compose -f docker-compose.prod.yml -f docker-compose.prod.override.yml up -d

            # Wait for services to be ready
            echo "Waiting for services to start..."
            sleep 30

            # Health checks
            echo "Running health checks..."

            for i in {1..10}; do
              if docker exec bo1-api-prod curl --fail --silent http://localhost:8000/api/health; then
                echo "‚úÖ API is healthy"
                break
              fi
              echo "Waiting for API... ($i/10)"
              sleep 3
              if [ $i -eq 10 ]; then
                echo "‚ùå API health check failed"
                docker-compose -f docker-compose.prod.yml logs --tail=50 api
                exit 1
              fi
            done

            # Additional health checks (database and redis)
            echo "Checking database connectivity..."
            if ! docker exec bo1-api-prod curl --fail --silent http://localhost:8000/api/health/db; then
              echo "‚ùå Database health check failed"
              docker-compose -f docker-compose.prod.yml logs --tail=50 api
              exit 1
            fi

            echo "Checking Redis connectivity..."
            if ! docker exec bo1-api-prod curl --fail --silent http://localhost:8000/api/health/redis; then
              echo "‚ùå Redis health check failed"
              docker-compose -f docker-compose.prod.yml logs --tail=50 api
              exit 1
            fi

            # Run database migrations
            echo "Running database migrations..."
            docker-compose -f docker-compose.prod.yml -f docker-compose.prod.override.yml exec -T api alembic upgrade head

            # Test nginx configuration
            echo "Testing nginx configuration..."
            if ! sudo nginx -t; then
              echo "‚ùå Nginx configuration test failed"
              exit 1
            fi

            # Reload nginx
            sudo systemctl reload nginx
            echo "‚úÖ Nginx reloaded"

            # Monitor for 1 minute
            echo "Monitoring for errors..."
            sleep 60

            # Check for errors
            ERROR_COUNT=$(docker-compose -f docker-compose.prod.yml -f docker-compose.prod.override.yml logs --tail=100 | grep -i "error\|exception\|failed" | grep -v "health" | wc -l)
            if [ $ERROR_COUNT -gt 10 ]; then
              echo "‚ö†Ô∏è Warning: High error rate detected ($ERROR_COUNT errors)"
              echo "Continuing anyway - check logs manually"
            fi

            echo "‚úÖ Deployment successful: ${GITHUB_SHA}"

            # Cleanup
            docker system prune -f --filter "until=72h"

      - name: Post-deployment validation
        run: |
          echo "Running post-deployment validation..."
          sleep 10

          # Test production endpoints
          curl --fail https://boardof.one/api/health || exit 1
          curl --fail https://boardof.one/api/health/db || exit 1
          curl --fail https://boardof.one/api/health/redis || exit 1

          echo "‚úÖ Post-deployment validation passed"

  create-release:
    name: Create GitHub Release
    needs: deploy-to-production
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Generate version tag
        id: version
        run: |
          # Get current date for beta versioning
          VERSION="v1.0.0-beta.$(date +%Y%m%d.%H%M)"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Generate changelog from commits since last release
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGES=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            ## üöÄ Production Deployment

            **Deployed at**: ${{ github.event.head_commit.timestamp }}
            **Commit**: ${{ github.sha }}
            **Deployed by**: ${{ github.actor }}

            ### Changes
            ${{ steps.changelog.outputs.changes }}

            ### Deployment Details
            - Environment: Production
            - URL: https://boardof.one
            - Method: Blue-Green Deployment

            ### Health Checks
            - ‚úÖ API Health
            - ‚úÖ Database Connection
            - ‚úÖ Redis Connection
            - ‚úÖ All integration tests passed
          draft: false
          prerelease: true  # Mark as pre-release for beta

  notify:
    name: Notify Team
    needs: [deploy-to-production, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify via ntfy.sh
        run: |
          if [ "${{ secrets.NTFY_TOPIC }}" != "" ]; then
            STATUS="${{ needs.deploy-to-production.result }}"
            if [ "$STATUS" == "success" ]; then
              curl -H "Title: üéâ Production Deployment Successful" \
                   -H "Priority: high" \
                   -H "Tags: rocket,success" \
                   -d "Commit: ${{ github.sha }} deployed to production by ${{ github.actor }}" \
                   https://ntfy.sh/${{ secrets.NTFY_TOPIC }}
            else
              curl -H "Title: ‚ùå Production Deployment Failed" \
                   -H "Priority: urgent" \
                   -H "Tags: warning,failure" \
                   -d "Commit: ${{ github.sha }} failed to deploy. Check logs." \
                   https://ntfy.sh/${{ secrets.NTFY_TOPIC }}
            fi
          fi
