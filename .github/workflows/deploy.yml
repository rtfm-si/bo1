name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target (blue or green)'
        required: true
        default: 'green'
        type: choice
        options:
          - green
          - blue

env:
  PROD_HOST: 139.59.201.65
  PROD_USER: root

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment target
        id: target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "target=${{ github.event.inputs.target }}" >> $GITHUB_OUTPUT
          else
            echo "target=green" >> $GITHUB_OUTPUT
          fi

      - name: Set deployment variables
        id: vars
        run: |
          if [ "${{ steps.target.outputs.target }}" == "green" ]; then
            echo "api_port=8001" >> $GITHUB_OUTPUT
            echo "frontend_port=3001" >> $GITHUB_OUTPUT
            echo "project=boardofone-green" >> $GITHUB_OUTPUT
            echo "static_dir=static-green" >> $GITHUB_OUTPUT
          else
            echo "api_port=8000" >> $GITHUB_OUTPUT
            echo "frontend_port=3000" >> $GITHUB_OUTPUT
            echo "project=boardofone" >> $GITHUB_OUTPUT
            echo "static_dir=static" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.PROD_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to production
        run: |
          ssh ${{ env.PROD_USER }}@${{ env.PROD_HOST }} << 'ENDSSH'
            set -e
            cd /root/bo1

            echo "==> Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "==> Building and deploying ${{ steps.target.outputs.target }}..."
            export API_PORT=${{ steps.vars.outputs.api_port }}
            export FRONTEND_PORT=${{ steps.vars.outputs.frontend_port }}

            docker-compose -f docker-compose.app.yml -p ${{ steps.vars.outputs.project }} build
            docker-compose -f docker-compose.app.yml -p ${{ steps.vars.outputs.project }} up -d

            echo "==> Extracting static assets..."
            sleep 5  # Wait for container to be ready
            docker cp ${{ steps.vars.outputs.project }}-frontend-1:/app/build/client/. /var/www/boardofone/${{ steps.vars.outputs.static_dir }}/

            echo "==> Deployment complete!"
            docker-compose -f docker-compose.app.yml -p ${{ steps.vars.outputs.project }} ps
          ENDSSH

      - name: Health check
        run: |
          echo "Waiting for services to be ready..."
          sleep 10

          # Check frontend
          if [ "${{ steps.target.outputs.target }}" == "green" ]; then
            curl -f -s -o /dev/null http://${{ env.PROD_HOST }}:3001 && echo "Frontend OK" || echo "Frontend check failed"
          else
            curl -f -s -o /dev/null http://${{ env.PROD_HOST }}:3000 && echo "Frontend OK" || echo "Frontend check failed"
          fi
