# Production Environment Setup

This guide covers the environment variables and secrets needed for production deployment.

## Secret Management Architecture

Board of One uses a **simple, 2-location** approach:

1. **Local Development**: `.env` file on your laptop
2. **Production Server**: `.env` file at `/opt/boardofone/.env`

GitHub Actions **only** needs SSH credentials to deploy - all application secrets live in the production `.env` file.

---

## Required GitHub Secrets (SSH Only)

Add these secrets at: `https://github.com/rtfm-si/bo1/settings/secrets/actions`

| Secret Name | Description | How to Generate |
|-------------|-------------|-----------------|
| `PRODUCTION_HOST` | Server IP address | `139.59.201.65` |
| `PRODUCTION_USER` | SSH username | `root` or `deploy` |
| `PRODUCTION_SSH_KEY` | Private SSH key | `cat ~/.ssh/id_rsa_github_actions` |
| `PRODUCTION_SSH_PORT` | SSH port (optional) | `22` (default) |

**That's it!** All application secrets (API keys, passwords) go in the server `.env` file, not GitHub.

## Production Server .env File

### Quick Setup

SSH to production server and create `.env`:

```bash
ssh root@139.59.201.65
cd /opt/boardofone

# Copy from template
cp .env.production.example .env

# Edit and fill in all values
nano .env

# Secure permissions
chmod 600 .env
```

### Required Variables

The `.env` file must contain these variables (see `.env.production.example` for complete template):

| Variable | Description | Generate With |
|----------|-------------|---------------|
| `POSTGRES_PASSWORD` | PostgreSQL password | `openssl rand -base64 32` |
| `REDIS_PASSWORD` | Redis password | `openssl rand -base64 32` |
| `ANTHROPIC_API_KEY` | Claude API key | Anthropic Console |
| `VOYAGE_API_KEY` | Voyage AI embeddings | Voyage Console |
| `SUPABASE_JWT_SECRET` | JWT signing secret | `openssl rand -base64 32` |
| `SUPABASE_ANON_KEY` | Supabase anon key | Supabase Console |
| `ADMIN_API_KEY` | Admin API key | `openssl rand -base64 32` |

**Optional** (for research features):
- `TAVILY_API_KEY` - Tavily web search
- `BRAVE_API_KEY` - Brave Search API

**Optional** (for social OAuth):
- `GOOGLE_OAUTH_CLIENT_ID` / `GOOGLE_OAUTH_CLIENT_SECRET`
- `LINKEDIN_OAUTH_CLIENT_ID` / `LINKEDIN_OAUTH_CLIENT_SECRET`
- `GITHUB_OAUTH_CLIENT_ID` / `GITHUB_OAUTH_CLIENT_SECRET`

## Production-Specific Overrides

The deployment creates `docker-compose.prod.override.yml` automatically.

**Important**: nginx runs **standalone on the host**, not in a container. The override file is intentionally empty:

```yaml
# /opt/boardofone/docker-compose.prod.override.yml
# Auto-generated by GitHub Actions deployment

version: '3.8'
services: {}  # Empty - nginx runs on host
```

This prevents port conflicts with host nginx listening on 80/443.

## Initial Setup (Step-by-Step)

### 1. Add GitHub Secrets (SSH credentials only)

Go to: https://github.com/rtfm-si/bo1/settings/secrets/actions

Add these **4 secrets**:
- `PRODUCTION_HOST` = `139.59.201.65`
- `PRODUCTION_USER` = `root` (or `deploy`)
- `PRODUCTION_SSH_KEY` = (SSH private key from `setup-github-ssh-keys.sh`)
- `PRODUCTION_SSH_PORT` = `22` (optional)

### 2. SSH into Production Server

```bash
ssh root@139.59.201.65
cd /opt/boardofone
```

### 3. Create .env File from Template

```bash
# Copy template
cp .env.production.example .env

# Generate passwords
echo "POSTGRES_PASSWORD=$(openssl rand -base64 32)"
echo "REDIS_PASSWORD=$(openssl rand -base64 32)"
echo "SUPABASE_JWT_SECRET=$(openssl rand -base64 32)"
echo "ADMIN_API_KEY=$(openssl rand -base64 32)"

# Edit .env and fill in ALL values (paste generated passwords)
nano .env

# Secure permissions
chmod 600 .env
```

### 4. Verify .env File

```bash
# Check all required variables are set
grep -E "^(POSTGRES_PASSWORD|REDIS_PASSWORD|ANTHROPIC_API_KEY|VOYAGE_API_KEY)" .env

# Should see non-empty values (not "REPLACE_WITH_...")
```

### 5. Test First Deployment

Run the fix script to ensure everything works:

```bash
bash deployment-scripts/fix-deployment-issues.sh
```

This will:
- Verify `.env` exists and is valid
- Remove old override files
- Start services
- Run health checks

## Deployment via GitHub Actions

Once `.env` is configured on the server:

1. Go to **Actions** tab → **Deploy to Production**
2. Click **Run workflow**
3. Type `deploy-to-production` to confirm
4. Monitor deployment progress

The workflow will:
- ✅ SSH to production server
- ✅ Pull latest code
- ✅ Verify `.env` exists (fails if missing)
- ✅ Create empty override file (no nginx)
- ✅ Build and start containers
- ✅ Run health checks
- ✅ Reload host nginx

---

## Troubleshooting

### "POSTGRES_PASSWORD variable is not set"
**Cause**: `.env` file missing or incomplete on production server

**Fix**:
```bash
ssh root@139.59.201.65
cd /opt/boardofone
cp .env.production.example .env
nano .env  # Fill in all values
chmod 600 .env
```

### "Port 80/443 already in use"
**Cause**: Trying to start containerized nginx when host nginx is already running

**Fix**: Already resolved! The workflow now creates an empty override file that excludes nginx.

### ".env file not found"
**Cause**: Deployment expects `.env` at `/opt/boardofone/.env` but it doesn't exist

**Fix**: Run `deployment-scripts/fix-deployment-issues.sh` on the server

### SSL Certificate Issues
- Production uses Let's Encrypt at `/etc/letsencrypt/live/boardof.one`
- Host nginx (not container) reads these certificates
- nginx config: `/etc/nginx/sites-enabled/boardofone.conf` (points to `nginx/nginx-blue.conf`)

---

## Secret Management Summary

| Location | Purpose | Contains |
|----------|---------|----------|
| **GitHub Secrets** | SSH credentials for deployment | PRODUCTION_HOST, PRODUCTION_USER, PRODUCTION_SSH_KEY |
| **Server .env** | Application secrets | POSTGRES_PASSWORD, API keys, all runtime config |
| **Local .env** | Development | Same as server .env but with dev values |

**Simple rule**: GitHub has **SSH keys only**. Everything else is in `.env` files.
