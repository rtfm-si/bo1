# =============================================================================
# Docker Compose - Application Services (API + Frontend)
# For Blue-Green Deployment
# =============================================================================
# Usage:
#   Blue:  API_PORT=8000 FRONTEND_PORT=3000 docker-compose -f docker-compose.app.yml -p boardofone up -d
#   Green: API_PORT=8001 FRONTEND_PORT=3001 docker-compose -f docker-compose.app.yml -p boardofone-green up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # FastAPI: Web API for deliberation endpoints
  # ---------------------------------------------------------------------------
  api:
    image: ghcr.io/rtfm-si/bo1/api:${IMAGE_TAG:-latest}
    # Build configuration (for local dev only, production pulls pre-built images)
    build:
      context: .
      dockerfile: backend/Dockerfile
      target: production
      args:
        - BUILD_TIMESTAMP=${BUILD_TIMESTAMP:-}
        - GIT_COMMIT=${GIT_COMMIT:-}
    # JSON file logging for Promtail file-based scraping (no Docker socket needed)
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,compose_project"
    labels:
      - "service=api"
      - "compose_project=boardofone"
    environment:
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - REDIS_PASSWORD=${REDIS_PASSWORD}

      # Checkpoint Configuration (redis or postgres)
      - CHECKPOINT_BACKEND=${CHECKPOINT_BACKEND:-redis}

      # PostgreSQL Configuration
      - DATABASE_URL=postgresql://bo1:${POSTGRES_PASSWORD}@postgres:5432/boardofone

      # API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - RESEND_API_KEY=${RESEND_API_KEY:-}

      # DigitalOcean Spaces Configuration
      - DO_SPACES_KEY=${DO_SPACES_KEY}
      - DO_SPACES_SECRET=${DO_SPACES_SECRET}
      - DO_SPACES_BUCKET=${DO_SPACES_BUCKET}
      - DO_SPACES_REGION=${DO_SPACES_REGION:-lon1}
      - DO_SPACES_ENDPOINT=${DO_SPACES_ENDPOINT:-https://lon1.digitaloceanspaces.com}
      - DO_SPACES_CDN_ENDPOINT=${DO_SPACES_CDN_ENDPOINT:-}

      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_RELOAD=false
      - CORS_ORIGINS=${CORS_ORIGINS}
      - ADMIN_API_KEY=${ADMIN_API_KEY}

      # SuperTokens Configuration
      - SUPERTOKENS_CONNECTION_URI=${SUPERTOKENS_CONNECTION_URI:-http://supertokens:3567}
      - SUPERTOKENS_API_KEY=${SUPERTOKENS_API_KEY}
      - SUPERTOKENS_API_DOMAIN=${SUPERTOKENS_API_DOMAIN:-https://boardof.one}
      - SUPERTOKENS_WEBSITE_DOMAIN=${SUPERTOKENS_WEBSITE_DOMAIN:-https://boardof.one}
      - COOKIE_SECURE=${COOKIE_SECURE:-true}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-boardof.one}

      # OAuth Provider Credentials
      - GOOGLE_OAUTH_ENABLED=${GOOGLE_OAUTH_ENABLED:-false}
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET}
      - GOOGLE_SEARCH_CONSOLE_ENABLED=${GOOGLE_SEARCH_CONSOLE_ENABLED:-false}

      # Application Configuration
      - DEBUG=false
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Closed Beta Configuration
      - CLOSED_BETA_MODE=${CLOSED_BETA_MODE:-true}

      # ntfy Push Notifications
      - NTFY_SERVER=${NTFY_SERVER:-https://ntfy.boardof.one}
      - NTFY_TOPIC_WAITLIST=${NTFY_TOPIC_WAITLIST}
      - NTFY_TOPIC_MEETING=${NTFY_TOPIC_MEETING}
      - NTFY_TOPIC_REPORTS=${NTFY_TOPIC_REPORTS}
      - NTFY_TOPIC_ALERTS=${NTFY_TOPIC_ALERTS}

      # E2E Testing (protected by secret)
      - E2E_AUTH_SECRET=${E2E_AUTH_SECRET:-}
    ports:
      - "127.0.0.1:${API_PORT:-8000}:8000"
    networks:
      - bo1-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Frontend: SvelteKit Web UI
  # ---------------------------------------------------------------------------
  frontend:
    image: ghcr.io/rtfm-si/bo1/frontend:${IMAGE_TAG:-latest}
    # Build configuration (for local dev only, production pulls pre-built images)
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    # JSON file logging for Promtail file-based scraping (no Docker socket needed)
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,compose_project"
    labels:
      - "service=frontend"
      - "compose_project=boardofone"
    environment:
      - NODE_ENV=production
      - PUBLIC_API_URL=https://boardof.one
      - PUBLIC_UMAMI_HOST=https://analytics.boardof.one
      - PUBLIC_UMAMI_WEBSITE_ID=d996d0e6-74d8-4cac-bbde-215437f7c703
      - ORIGIN=https://boardof.one
      # Google Picker API (for drive.file scope)
      - PUBLIC_GOOGLE_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID}
      - PUBLIC_GOOGLE_API_KEY=${GOOGLE_API_KEY}
    ports:
      - "127.0.0.1:${FRONTEND_PORT:-3000}:3000"
    networks:
      - bo1-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  bo1-network:
    name: bo1-network
    external: true
