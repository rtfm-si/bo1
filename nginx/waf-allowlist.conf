# WAF Allowlist Configuration for Board of One
# Prevents false positives on legitimate endpoints
# Include in http block after waf-rules.conf

# -----------------------------------------------------------------------------
# Allowlist: Endpoints that bypass WAF body inspection
# These endpoints legitimately accept SQL/code in request bodies
# -----------------------------------------------------------------------------
map $uri $waf_allowlist {
    default 0;

    # Dataset Q&A - users can ask questions containing SQL/code snippets
    ~*/api/v1/datasets/[^/]+/ask$ 1;

    # SSE streaming - no body inspection needed
    ~*/api/v1/sessions/[^/]+/stream$ 1;

    # Health endpoints - skip WAF entirely
    ~*/api/health 1;
    ~*/api/ready 1;

    # OAuth callbacks - state params may contain special chars
    ~*/api/v1/auth/google/.*/callback 1;
    ~*/api/v1/auth/callback 1;

    # Error reporting - stack traces may contain code that looks like XSS
    ~*/api/errors$ 1;
}

# -----------------------------------------------------------------------------
# Final WAF decision: block unless allowlisted
# Used in server block: if ($waf_should_block) { return 403; }
# -----------------------------------------------------------------------------
map $waf_blocked$waf_allowlist $waf_should_block {
    # waf_blocked=0, allowlist=any -> don't block
    "00" 0;
    "01" 0;
    # waf_blocked=1, allowlist=1 -> don't block (allowlisted)
    "11" 0;
    # waf_blocked=1, allowlist=0 -> block
    "10" 1;
    default 0;
}
