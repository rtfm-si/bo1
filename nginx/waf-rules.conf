# WAF Rules for Board of One
# Blocks common attack patterns at edge (SQLi, XSS, path traversal)
# Include in http block: include /etc/nginx/waf-rules.conf;

# -----------------------------------------------------------------------------
# Map: Detect SQL Injection patterns
# -----------------------------------------------------------------------------
map $request_uri $waf_block_sqli {
    default 0;
    # UNION-based injection
    ~*union\s+(all\s+)?select 1;
    # Basic SQL keywords with suspicious context
    ~*[\s'"`;]+(select|insert|update|delete|drop|alter|create|truncate)\s+ 1;
    # Comment-based injection
    ~*--\s*$ 1;
    ~*/\*.*\*/ 1;
    # OR-based bypass
    ~*'\s*or\s*'?1\s*[=<>] 1;
    ~*'\s*or\s*'[^']*'\s*[=<>] 1;
    # Encoded variants
    ~*%27\s*(or|and)\s* 1;
    ~*0x[0-9a-f]+\s+(union|select) 1;
}

map $args $waf_block_sqli_args {
    default 0;
    ~*union\s+(all\s+)?select 1;
    ~*[\s'"`;]+(select|insert|update|delete|drop|alter|create|truncate)\s+ 1;
    ~*--\s*$ 1;
    ~*/\*.*\*/ 1;
    ~*'\s*or\s*'?1\s*[=<>] 1;
    ~*%27\s*(or|and)\s* 1;
}

# -----------------------------------------------------------------------------
# Map: Detect XSS patterns
# -----------------------------------------------------------------------------
map $request_uri $waf_block_xss {
    default 0;
    # Script tags
    ~*<\s*script 1;
    ~*</\s*script 1;
    # Event handlers
    ~*\s+on(error|load|click|mouse|focus|blur|change|submit|key|touch)\s*= 1;
    # JavaScript protocol
    ~*javascript\s*: 1;
    # Data URI with script
    ~*data\s*:[^,]*;base64 1;
    # Expression/vbscript
    ~*expression\s*\( 1;
    ~*vbscript\s*: 1;
    # Encoded variants
    ~*%3c\s*script 1;
    ~*%3cscript 1;
}

map $args $waf_block_xss_args {
    default 0;
    ~*<\s*script 1;
    ~*</\s*script 1;
    ~*\s+on(error|load|click|mouse|focus|blur|change|submit|key|touch)\s*= 1;
    ~*javascript\s*: 1;
    ~*%3c\s*script 1;
}

# -----------------------------------------------------------------------------
# Map: Detect Path Traversal patterns
# -----------------------------------------------------------------------------
map $request_uri $waf_block_traversal {
    default 0;
    # Directory traversal
    ~*\.\./ 1;
    ~*\.\.%2f 1;
    ~*%2e%2e/ 1;
    ~*%2e%2e%2f 1;
    # Null byte injection
    ~*%00 1;
    # Windows path traversal
    ~*\.\.\\  1;
    ~*%2e%2e\\ 1;
}

# -----------------------------------------------------------------------------
# Map: Block common probes and scanners
# -----------------------------------------------------------------------------
map $request_uri $waf_block_probe {
    default 0;
    # Sensitive files
    ~*\.env$ 1;
    ~*\.env\. 1;
    ~*\.git/ 1;
    ~*\.svn/ 1;
    ~*\.hg/ 1;
    # Config files
    ~*\.htaccess$ 1;
    ~*\.htpasswd$ 1;
    ~*web\.config$ 1;
    ~*\.DS_Store$ 1;
    # WordPress/PHP probes
    ~*/wp-admin 1;
    ~*/wp-login 1;
    ~*/wp-content 1;
    ~*/wp-includes 1;
    ~*/xmlrpc\.php 1;
    ~*/phpmyadmin 1;
    ~*/phpMyAdmin 1;
    ~*/pma/ 1;
    ~*/mysql/ 1;
    ~*/adminer 1;
    # Common scanner paths
    ~*/admin\.php 1;
    ~*/shell\.php 1;
    ~*/c99\.php 1;
    ~*/r57\.php 1;
    ~*/config\.php\.bak 1;
    ~*/backup\.sql 1;
    ~*/dump\.sql 1;
    # AWS metadata
    ~*/latest/meta-data 1;
    ~*/169\.254\.169\.254 1;
}

# -----------------------------------------------------------------------------
# Map: Detect malicious user agents
# -----------------------------------------------------------------------------
map $http_user_agent $waf_block_agent {
    default 0;
    ~*sqlmap 1;
    ~*nikto 1;
    ~*nmap 1;
    ~*masscan 1;
    ~*nessus 1;
    ~*openvas 1;
    ~*havij 1;
    ~*acunetix 1;
    ~*w3af 1;
    ~*dirbuster 1;
    ~*gobuster 1;
    ~*wpscan 1;
}

# -----------------------------------------------------------------------------
# Combine all WAF checks into single variable
# -----------------------------------------------------------------------------
map $waf_block_sqli$waf_block_sqli_args$waf_block_xss$waf_block_xss_args$waf_block_traversal$waf_block_probe$waf_block_agent $waf_blocked {
    default 0;
    ~*1 1;
}

# -----------------------------------------------------------------------------
# WAF log format (for blocked requests)
# -----------------------------------------------------------------------------
log_format waf_blocked '$remote_addr - [$time_local] "$request" '
                       'sqli=$waf_block_sqli$waf_block_sqli_args '
                       'xss=$waf_block_xss$waf_block_xss_args '
                       'traversal=$waf_block_traversal '
                       'probe=$waf_block_probe '
                       'agent=$waf_block_agent '
                       'ua="$http_user_agent"';
